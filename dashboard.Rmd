---
title: "Who is Looking for a New Job?"
output: 
  flexdashboard::flex_dashboard:
    runtime: shiny
    orientation: rows
---
```{r setup, include=FALSE}
#^^^NOTE the different header above^^^
#This is because I use a reactive environment on page 3 now

#Incorporating Shiny (interactive) components into flexdashboard:
#https://rmarkdown.rstudio.com/flexdashboard/shiny.html#simple_example
library(flexdashboard)
library(ggplot2)
library(dplyr)
library(RColorBrewer)
library(reshape2)
library(randomForest)
library(pROC)


# Set working directory
setwd("~/DRAKE_DEV/SPRING_2021/STAT_190/newJob")

# Read in data
jobs <- read.csv("aug_train.csv")


# Clean Data --------------------------------------------------------------
# Currently any missing value is stored as a blank character, "", rather than NA
# First for each variable we make the missing values = NA
# Then I factor each categorical variable
jobs$enrollee_id[jobs$enrollee_id == ""] <- NA

jobs$city[jobs$city == ""] <- NA
jobs$city <- as.factor(jobs$city)

jobs$city_development_index[jobs$city_development_index == ""] <- NA


jobs$gender[jobs$gender == ""] <- NA
jobs$gender <- as.factor(jobs$gender)

jobs$relevent_experience[jobs$relevent_experience == ""] <- NA
jobs$relevent_experience <- as.factor(jobs$relevent_experience)

jobs$enrolled_university[jobs$enrolled_university == ""] <- NA
jobs$enrolled_university <- as.factor(jobs$enrolled_university)

jobs$education_level[jobs$education_level == ""] <- NA
jobs$education_level <- as.factor(jobs$education_level)

jobs$major_discipline[jobs$major_discipline == ""] <- NA
jobs$major_discipline <- as.factor(jobs$major_discipline)

jobs$experience[jobs$experience == ""] <- NA
jobs$experience <- factor(jobs$experience ,
                          levels = c("<1", "1", "2", "3", "4", "5", "6", "7", "8",
                                     "9", "10", "11", "12", "13", "14", "15", "16",
                                     "17", "18", "19", ">20"))

jobs$company_size[jobs$company_size == ""] <- NA
jobs$company_size <- as.factor(jobs$company_size)

jobs$company_type[jobs$company_type == ""] <- NA
jobs$company_type <- as.factor(jobs$company_type)

jobs$last_new_job[jobs$last_new_job == ""] <- NA
jobs$last_new_job <- as.factor(jobs$last_new_job)

jobs$training_hours[jobs$training_hours == ""] <- NA
jobs$target[jobs$target == ""] <- NA
jobs$target <- as.factor(jobs$target)

# Use na.roughfix to fill in the missing values so there will not be any errors
# when creating the random forest
jobs <- na.roughfix(jobs)
```

Data Overview
===================================== 

Row 
-----------------------------------------------------------------------
### Introduction
This data set consists of data for whether or not a person is interested in leaving
their current job. This data comes from a company who hires their data science teams
by hosting workshops that are open to everyone, with the hope that they will be able
to find outstanding participants to poach from their current company. However, not
everyone who attends these workshops are looking for a job change. These participants
ultimately cause the host to loose money, as they are not getting a potential new
hire from the event. Because of this, the company wants to know whether or not 
a person is looking for a job change so that they can begin to only allow those individuals
to sign up for the workshop

### Research Questions
The ultimate research question for this project is: "Is this person looking for a job
change in the field of data analytics"

In order to answer this question, I will be creating a random forest that will allow
for the host company to predict whether or not a participant is looking for a new job

Row 
-----------------------------------------------------------------------
### Variable Explanation
This data set's y variable is "target" which is 1 if the person is interested in leaving
their current job and 0 if not. This data set also has 13 x variables which are:  
•	enrollee_id: Unique ID for candidate  
•	city: City code  
•	city_development_index: Development index of the city (scaled)  
•	gender: Gender of candidate  
•	relevent_experience: Relevant experience of candidate  
•	enrolled_university: Type of University course enrolled if any  
•	education_level: Education level of candidate  
•	major_discipline: Education major discipline of candidate  
•	experience: Candidate total experience in years  
•	company_size: No of employees in current employer's company  
•	company_type: Type of current employer  
•	lastnewjob: Difference in years between previous job and current job  
•	training_hours: training hours completed  


### Data Cleaning
There was not much data cleaning that had to be done in order to get this data set
ready to be used. The biggest issue was the large number of missing values. These
missing values were also stored as " " (just a space), rather than just being left
empty. This meant that for every variable, I had to change the spaces to be the
NA value. I wanted them as NA values so that I could use na.roughfix in order to 
get an average value in there so that my random forest would run without any errors.
In addition, for each categorical variable, I had to make it a factor using as.factor.


Exploratory Analysis
===================================== 

Row
-----------------------------------------------------------------------

### Looking at the relationship between City Development Index and Target
```{r cdiPlot, include=TRUE}
# Looking at City Development Index
ggplot(data = jobs) +
  geom_jitter(aes(x = target, y = city_development_index), alpha = I(.4), colour = "grey") +
  geom_boxplot(aes(x = target, y = city_development_index), alpha = 0) +
  labs(x = "Target", y = "City Development Index") +
  theme_bw()
```


### Looking at the relationship between Training Hours and Target
```{r trainHrsPlot, include=TRUE}
# Looking at number of training hours
ggplot(data = jobs) +
  geom_jitter(aes(x = target, y = training_hours), alpha = I(.4), colour = "grey") +
  geom_boxplot(aes(x = target, y = training_hours), alpha = 0) +
  labs(x = "Target", y = "Number of Training Hours") +
  theme_bw()
```

Row 
-----------------------------------------------------------------------

### Looking at the relationship between Relevent Experience and Target
```{r revExPlot, include=TRUE}
# Looking at relevent experience
ggplot(data = jobs) +
  geom_bar(aes(x = relevent_experience, fill = target), position="fill") +
  ggtitle("Relation of Relevent Experience vs Target") +
  labs(x = "Relevent Experience",
       y = "Proportional Amount") +
  scale_fill_grey("Target") + 
  scale_colour_grey("Target") + 
  theme_bw()

```

### Looking at the relationship between Experience and Target
```{r expPlot, include=TRUE}
# Now just experience
ggplot(data = jobs) +
  geom_bar(aes(x = experience, fill = target), position="fill") +
  ggtitle("Relation of Experience vs Target") +
  labs(x = "Experience",
       y = "Proportional Amount") +
  scale_fill_grey("Target") + 
  scale_colour_grey("Target") + 
  theme_bw()
```

The Random Forest
===================================== 
```{r randForest, include=FALSE}

RNGkind(sample.kind = "default")
set.seed(190)
train.idx <- sample(x = 1:nrow(jobs), size = floor(.8*nrow(jobs)))
train.df <- jobs[train.idx,]
test.df <- jobs[-train.idx,] 

keeps2 <- data.frame("m"=c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11), 
                      "OOB_err_rate"=c(0.2420723, 0.2224325, 0.2256296, 0.2288268,
                                       0.2308495, 0.2315020, 0.2311105, 0.2328070,
                                       0.2334595, 0.2320893, 0.2348297))

final_forest <- randomForest(target ~ city_development_index + gender + relevent_experience +
                           enrolled_university + education_level + major_discipline +
                           experience + company_size + company_type + last_new_job + training_hours,
                         data = train.df,
                         ntree = 1000,
                         mtry = 2, 
                         importance = TRUE) 
```

Row
-----------------------------------------------------------------------

### About the Random Forest
In order to solve my research questions, I created a random forest to predict 
the y variable of target. In order to do this I used 11 out of the 13 provided x
variables. The two x variables I did not use were "enrollee_id" and "city". I did
not include "enrollee_id" in the prediction method because it is simply a unique 
identifier that has nothing to do with the y variable and how it would be decided. 
I originally did want to use "city" in the prediction, however the variable was 
categorical with over 53 different categories so the random forest would produce 
an error with this variable included. In addition, there is no information about 
what city each code corresponds to so it is impossible to even do anything like 
recode the variable into something more broad such as by states.With this in mind, 
I created a baseline forest that was very large and had an mtry value of 11. After 
creating this massive tree, I wanted to find the tree that minimized the out of 
bag error rate. I found this by looping through forests with mtry values of 1 through 
11 and then creating my final forest with a mtry value that minimized the OOB error rate.

### mtry Graph

```{r mtry, include=TRUE}
qplot(m, OOB_err_rate, geom = c("line", "point"), data = keeps2) + 
  theme_bw() + labs(x = "m (mtry) value", y = "OOB error rate")
```


Row
-----------------------------------------------------------------------

### ROC Curve
```{r rocCurve}
test.df$forest_pred <- predict(final_forest, test.df, type = "class")
pi_hat <- predict(final_forest, test.df, type = "prob")[, 1]

rocCurve <- roc(response = test.df$target,
                predictor = as.vector(pi_hat),
                levels = c(0, 1))

plot(rocCurve, print.auc = TRUE, print.thres = TRUE)
```


### Variable Importance Plot
```{r varImp}
varImpPlot(final_forest, type = 1)
```


Make a Prediction
===================================== 
Inputs {.sidebar}
-----------------------------------------------------------------------

```{r inputs}
sliderInput("cdi.input", label = "City Development Index:",
            min = 0, max = 1, value = 0.5, step = 0.001)
selectInput("gender.input", label = "Gender:",
            c("Male", "Female", "Other"), multiple = FALSE)
selectInput("revExp.input", label = "Relevant Experience:",
            c("Has relevent experience", "No relevent experience"), multiple = FALSE)
selectInput("enrollUni.input", label = "Enrolled University:",
            c("Full time course", "No enrollment" = "no_enrollment", "Part time course"), multiple = FALSE)
selectInput("eduLevel.input", label = "Education Level:",
            c("Graduate", "High School", "Masters", "Phd", "Primary School"), multiple = FALSE)
selectInput("majDis.input", label = "Major Discipline:",
            c("Arts", "Business" = "Business Degree", "Humanities", "No Major", "STEM", "Other"),
            multiple = FALSE)
selectInput("exp.input", label = "Experience:",
            c("<1", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", 
              "12", "13", "14", "15", "16", "17", "18", "19", ">20"), multiple = FALSE)
selectInput("compSize.input", label = "Company Size:",
            c("<10", "10-49", "50-99", "100-499", "500-999", "1000-4999", "5000-9999", "10000+"),
            multiple = FALSE)
selectInput("compType.input", label = "Company Type",
            c("Early Stage Startup", "Funded Startup", "NGO", "Public Sector", "Pvt Ltd", "Other"), 
            multiple = FALSE)
selectInput("lastNewJob.input", label = "Last New Job:",
            c("1", "2", "3", "4", ">4", "never"), multiple = FALSE)
sliderInput("trainingHrs.input", label = "Training Hours:",
            min = 0, max = 500, value = 250, step = 1)
```

Row 
-----------------------------------------------------------------------

### Prediction with given inputs

```{r }
renderValueBox({
  new.df <- data.frame(city_development_index = input$cdi.input,
                       gender = input$gender.input,
                       relevent_experience = input$revExp.input,
                       enrolled_university = input$enrollUni.input,
                       education_level = input$eduLevel.input,
                       major_discipline = input$majDis.input,
                       experience = input$exp.input,
                       company_size = input$compSize.input,
                       company_type = input$compType.input,
                       last_new_job = input$lastNewJob.input,
                       training_hours = input$trainingHrs.input)

prediction_class <- predict(final_forest, new.df, type = "class")

valueBox(prediction_class, 
           icon = "chart-line",
           color = "blue") 
  
})

```
